version: '3.9'

name: maco
networks:
  wg:
    ipam:
      config:
        # subnet CIDR hardcoded in
        # maco is reserved for addresses only above 10.8.1.100
        - subnet: 10.8.1.0/24

services:
#  cloudflared:
#    image: cloudflare/cloudflared:latest
#    command: tunnel run --no-autoupdate
#    env_file:
#      - secrets/cloudflared.env

  wg-client:
    image: linuxserver/wireguard:alpine
    restart: unless-stopped
    volumes:
      - ./wg:/config
    network_mode: host
#    networks: #[wg]
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    privileged: true
#    sysctls:
#      net.ipv4.ip_forward: 1
#      net.ipv4.conf.all.src_valid_mark: 1
#      net.ipv6.conf.all.disable_ipv6: 0
    environment:
      IPTABLES_MASQ: '0'

  whoami:
    image: traefik/whoami
    command:
      - --port=80
#    ports:
#      - '80:80'
    network_mode: host
#    networks:
#      wg:
#        ipv4_address: 10.8.1.101
    labels:
      traefik.enable: true
      traefik.http.routers.whoami.rule: Host(`web.vps.dcotta.eu`) && PathPrefix(`/whoami`)
      traefik.http.middlewares.whoami-stripprefix.stripprefix.prefixes: /whoami
      traefik.http.services.whoami.loadbalancer.server.port: 80
      traefik.http.routers.whoami.middlewares: whoami-stripprefix,auth@file
      traefik.http.routers.whoami.entrypoints: websecure
      traefik.http.routers.whoami.tls: true

